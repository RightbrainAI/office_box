name: "3. Finalize Vendor Records on Approval"

on:
  issues:
    types: [closed]

jobs:
  commit_vendor_data:
    # 1. Closed as completed
    # 2. Has 'vendor-approved' label
    if: >
      github.event.issue.state_reason == 'completed' &&
      contains(github.event.issue.labels.*.name, 'vendor-approved')
      
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Removed 'token' input; defaults to GITHUB_TOKEN which has write access per above permissions

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv requests

      - name: Run Finalize Script
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_CLOSED_AT: ${{ github.event.issue.closed_at }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: python scripts/commit_approved_vendor.py

      - name: Commit updated files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # NEW: Target the suppliers directory
          git add "suppliers/" "_vendor_analysis_source/"
          
          if ! git diff --staged --quiet; then
            git commit -m "docs(vendor): Finalize records for approved vendor #${{ github.event.issue.number }}"
            git push
          else
            echo "No new vendor files to commit."
          fi
          
         