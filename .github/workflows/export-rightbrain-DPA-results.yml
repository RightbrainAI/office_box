name: Rightbrain DPA Analysis

on:
  workflow_dispatch:
    inputs:
      task_url:
        description: 'Rightbrain Task URL'
        required: true
      run_id:
        description: 'Rightbrain Run ID'
        required: true
      repo_location:
        description: 'Repository Location (e.g., docs/)'
        required: true

jobs:
  export-results:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests
          pip install github3.py

      - name: Get Rightbrain access token
        id: get_token
        run: |
          python -c "
          import requests
          import json
          import base64

          # Rightbrain token endpoint URL
          token_url = 'https://oauth.leftbrain.me/oauth2/token'

          # Authentication data
          client_id = '29ee2a63-1437-4e5e-ab39-bde443fbea1f'
          client_secret = '${{ secrets.RIGHTBRAIN_API_KEY }}'
          auth_string = f'{client_id}:{client_secret}'
          auth_bytes = auth_string.encode('ascii')
          auth_base64 = base64.b64encode(auth_bytes).decode('ascii')
          
          headers = {
              'Authorization': f'Basic {auth_base64}',
              'Content-Type': 'application/x-www-form-urlencoded'
          }

          data = {
              'grant_type': 'client_credentials'
          }


          # Get the access token
          token_response = requests.post(token_url, headers=headers, data=data)
          token_data = json.loads(token_response.content)

          # Print the access token (for debugging)
          print('Token response:')
          print(token_data)
          access_token = token_data['access_token']
          print(access_token)
          print(f'::set-output name=token::{access_token}')
          "

      - name: Export Rightbrain results
        run: |
          REPO_LOCATION="${{ github.event.inputs.repo_location }}" python -c "
          import requests
          import json
          import github3
          import os

          # Get workflow inputs
          task_url = '${{ github.event.inputs.task_url }}'
          run_id = '${{ github.event.inputs.run_id }}'
          repo_location = os.environ.get('REPO_LOCATION')

          # Extract task ID from task URL
          task_id = task_url.split('/')[-2]


          # Rightbrain API endpoint
          url = f'https://stag.leftbrain.me/api/v1/org/01902fbf-6de7-a1cc-fb86-b1230a7af301/project/01902fc0-a119-26bc-827d-4138841301db/task/{task_id}/run/{run_id}'

          # Access token (read from the output of the previous step)
          access_token = '${{ steps.get_token.outputs.token }}'

          print(f'Access token before API call: {access_token}')
          headers = {
              'Authorization': f'Bearer {access_token}'
          }

          # Get the Rightbrain task output
          response = requests.get(url, headers=headers)

          if response.status_code != 200:
              print(f'API error: {response.status_code} - {response.text}')
          else:
              data = json.loads(response.content)
              risk_analysis = data['response']['Risk analysis']
              risk_register = data['response']['Risk register']
              dpa_amendments = data['response']['Rightbrain DPA amendments']

              # Format the data as markdown
              markdown_content = f'## Risk Analysis\n\n{risk_analysis}\n\n'
              markdown_content += '## Risk Register\n\n'
              markdown_content += '| Risk ID | Description | Likelihood | Impact | Mitigation Measures | Priority |\n'
              markdown_content += '|---|---|---|---|---|---|\n'

              for risk in risk_register:
                  markdown_content += f'| {risk['Risk ID']} | {risk['Description']} | {risk['Likelihood']} | {risk['Impact']} | {risk['Mitigation Measures']} | {risk['Priority']} |\n'

              markdown_content += f'\n## Rightbrain DPA Amendments\n\n{dpa_amendments}'


              # GitHub authentication
              gh = github3.login(token='${{ secrets.GITHUB_TOKEN }}')
              repository = gh.repository('RightbrainAI', 'suppliers')

              # GitHub authentication
              gh = github3.login(token='${{ secrets.GITHUB_TOKEN }}')
              repository = gh.repository('RightbrainAI', 'suppliers')

              # Encode markdown_content to bytes using UTF-8
              markdown_bytes = markdown_content.encode('utf-8')

              # Construct the file name and path
              if repo_location:
                  supplier = os.path.basename(repo_location)
                  file_name = f'{supplier} DPA automated analysis.md'
                  file_path = os.path.join(repo_location, file_name)
              else:
                  file_name = 'rightbrain-results.md'
                  file_path = file_name

              # Commit and push the markdown file
              try:
                  contents = repository.file_contents(file_path)
                  contents.update('Update Rightbrain results', markdown_bytes)
              except github3.exceptions.NotFoundError:
                  repository.create_file(file_path, 'Add Rightbrain results', markdown_bytes)
          "
      - name: Print output
        run: |
          echo 'Rightbrain results exported to rightbrain-results.md'
